# Prometheus?

SoundCloud에서 개발한 오픈소스 모니터링 시스템이자 일림 툴킷이다.    
이제는 독립형 오픈 소스 프로젝트이며,   
오픈 소스라는 사실을 알리고 프로젝트의 커버넌스 구조를 확립하기 위한 일환으로     
프로메테우스는 2016년에 쿠버네티르스를 잇는 두번째 호스팅 프로젝트로   
Cloud Native Computing Foundation 에 합류했다.     

프로메테우스는 메트릭을 **시계열 데이터**로 수집해 저장한다.        
메트릭 정보는 정보를 수집한 타임스탬프와 함께 저장하며       
키-값 쌍으로 구성된 레이블도 함께 저장할 수 있다.       

## Features   

* 메트릭 이름과 키/값 쌍으로 식별하는 다차원 데이터 모델을 시계열로 저장
* 다차원 모델을 다각도로 활용할 수 있는 유연한 쿼리 언어 PromQL 
* 분산 스토리지에 의존하지 않고 모든 서버 노드가 자율적으로 동작 
* HTTP를 통한 pull 모델로 시계열 수집 
* 중간 게이트웨이를 통한 시계열 push 지원
* 서비스 디스커버리나 스태틱 설정을 통한 모니터링 대상 타겟팅
* 다양한 그래프, 대시보드 모드 지원 


## Metrics
  
메트릭은 숫자로 측정한 값을 의미한다.         
시계열이란 말은 시간이 흐르면서 바뀌는 값들을 기록한다는 뜻이다.        
측정하고 싶은 값은 애플리케이션마다 다를 것이다.(웹 서버 - 요청시간, DB - 커넥션수)        
 
메트릭을 수집하면 애플리케이션의 동작 이유를 파악할 수 있다.     
예를 들어, '요청 수'를 메트릭하고 있다면 과한 요청에 따라 느려짐을 파악할 수 있다.   

## Componenets

프로메테우스 에코시스템은 다양한 컴포넌트로 이루어져 있으며, 컴포넌트 대부분은 옵션이다.   

* 시계열 데이터를 스크랩하고 저장하는 메인 프로메테우스 서버
* 애플리케이션 코드 계측용 클라이언트 라이브러리
* short-lived job 을 지원하는 푸시 게이트웨이
* HAProxy, StatsD, Graphite 등의 서비스를 위한 전용 익스포터들
* alert을 처리해주는 alertmanager 
* 다양한 지원 도구들 

프로메테우스 컴포넌트는 대부분 GO로 작성되어있기에 정적 바이너리로 쉽게 빌드하고 배포할 수 있다.  

## Architecture  
  
아래는 프로메테우스와 몇 가지 에코시스템 컴포넌트들의 아키텍처를 나타낸 다이어그램이다.  

![architecture](https://user-images.githubusercontent.com/50267433/165870249-914cd099-8f73-4124-bae2-ca44d2e24b46.png)

프로메테우스는 **설정한 Job에서 직접 메트릭을 스크랩하며**    
short-lived job 에서 중간 푸시 게이트웨이를 거치기도 한다.   
스크랩한 샘플은 모두 로컬에 저장하며       
설정해둔 rule 들을 실행해 기존 데이터를 집계하고 새 시계열을 기록하거나 alert을 생성한다.    
그라파나나 기타 API 컨슈머를 사용하면 수집한 데이터를 시각화할 수 있다.     

# when does it fit 
   
프로메테우스는 시계열로 수집할 수 있는 순수한 숫자 데이터를 기록하는 일에 적합하다.     
장비 관련 지표를 모니터링하기 좋으며 매우 동적인 서비스 지향 아키텍처 모니터링에도 적합하다.    
**마이크로 서비스 세계에서 다차원 데이터 수집과 질의를 지원한다는 점에서 특별하다**      

프로메테우스는 가동 중단시 문제를 신속하게 진단할 수 있는 시스템이 될 수 있도록 신뢰도를 중심으로 설계되었다.   
**프로메테우슨 서버는 각각 네트워크 스토리지나 다른 원격 서비스에 의존하지 않는 독립형 서버다.**   
인프라에 있는 다른 서버에 문제가 있을 때, 프로메테우스 서버를 신뢰하고 활용할 수 있으며  
프로메테우스를 위해 대규모 인프라를 세팅하지 않아도 된다.    

# when does it not fit.     

프로메테우스는 신뢰도를 중요한 가치로 여긴다.   
즉, 시스템에 오류가 있더라도 가능한 통계들은 항상 조회할 수 있도록 한다.    
하지만, 수집하는 데이터에 상세 정보를 모두 담기는 힘들고 완전하지 않을 수 있기에   
요청당 거래액 같이 100% 정확해야하는 데이터엔 프로메테우스를 이용하기는 어렵다.    

이런 상황에선 거래 데이터는 다른 시스템으로 수집, 분석하고 그외 다른 모니터링에 프로메테우스를 활용하는 것이 좋다.   
kafka 를 중간에 두어 유실이 안되게 한 후 수집하는 것도 나쁘지 않은 방법이다.   

